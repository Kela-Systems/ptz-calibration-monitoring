# PTZ Camera Self-Georegistration

This project provides a suite of tools to calculate the orientation of a PTZ (Pan-Tilt-Zoom) camera relative to a known reference map. The workflow involves three main stages: camera intrinsic calibration, reference alignment matrix (`R_align`) calibration, and finally, calculating the orientation offsets for new query images.

## Prerequisites

-   Python 3.9+
-   An NVIDIA GPU with CUDA drivers installed (for PyTorch acceleration).

## Setup Instructions

Follow these steps to set up the project environment.

**1. Unzip the Project**

First, unzip the provided project `.zip` file. This will create a project folder (likely named `ptz_self_georegistration`). Navigate into this directory from your terminal:

```bash
cd path/to/ptz_self_georegistration
```

**2. Create and Activate a Virtual Environment**

It is highly recommended to use a virtual environment to manage project dependencies.

*   On Windows:
    ```bash
    python -m venv .venv
    .\.venv\Scripts\activate
    ```
*   On macOS/Linux:
    ```bash
    python -m venv .venv
    source .venv/bin/activate
    ```

### 3. Install PyTorch with CUDA Support

The version of PyTorch required by this project depends on your specific NVIDIA driver and CUDA version. The packages this project was developed with (`torch==2.8.0+cu129`) were built for **CUDA 12.9**.

**First, check your system's CUDA version.** Open your terminal (Command Prompt, PowerShell, or bash) and run the following command:
```bash
nvidia-smi
```
Look for the `CUDA Version` in the top right corner of the output. Your version must be equal to or higher than the version required by the PyTorch build you choose.

**Next, get the correct installation command:**

*   **If your CUDA version is 12.9 or compatible:** You can likely use the same command that was used for development. However, `+cu129` is not a standard PyTorch wheel. It is safer to use the official build for a slightly different CUDA version, like 12.1 or 12.4, which PyTorch officially supports. Modern drivers are forward-compatible.

*   **For all cases (Recommended):** Go to the [Official PyTorch Website](https://pytorch.org/get-started/locally/) and use their tool to generate the correct `pip` command. Select the options that match your system (e.g., Stable, Windows, Pip, Python, your CUDA version).

    For example, the official command for PyTorch with CUDA 12.1 is:
    ```bash
    pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
    ```

*Run the command generated by the website. This is the most reliable way to ensure PyTorch can use your GPU.*


**4. Install Remaining Packages**

Once PyTorch is installed, install the rest of the project's dependencies using the `requirements.txt` file included in the project.

```bash
pip install -r requirements.txt
```

**5. Install the Project Package in Editable Mode**

This step is essential for making the project's internal imports (`from ptz_georeg import ...`) work correctly. Run this command from the project root directory:
```bash
pip install -e .
```

## Configuration

All executable scripts are configured using `.ini` files located in the `configs/` directory. **Before running any script, you must modify the corresponding configuration file** to set the correct paths, parameters, and settings for your experiment.

-   `configs/camera_calibration.ini`: For calibrating camera intrinsics.
-   `configs/calibration.ini`: For calibrating the `R_align` matrix.
-   `configs/orientation_offsets.ini`: For calculating offsets of query images.

## Workflow and Usage

The main workflow is divided into three steps. Run these commands from the project's root directory.

### Step 1: Camera Intrinsics Calibration

This script calculates the camera's intrinsic matrix and distortion coefficients using chessboard images.

1.  **Configure:** Edit `configs/camera_calibration.ini`.
2.  **Run:**
    ```bash
    python scripts/camera_calibration.py --config configs/camera_calibration.ini
    ```
3.  **Output:** A `calibration.npz` file will be saved.

### Step 2: Calibrate Alignment Matrix (R_align)

This script uses a set of reference images to find the rotational alignment (`R_align`) between the camera's and world's coordinate systems.

1.  **Configure:** Edit `configs/calibration.ini`.
2.  **Run:**
    ```bash
    python scripts/calibrate_R_align.py --config configs/calibration.ini
    ```
3.  **Output:** An `R_align.npy` matrix will be saved.

### Step 3: Calculate Orientation Offsets

This script takes query images and uses the pre-computed intrinsics and `R_align` matrix to calculate their orientation offsets.

1.  **Configure:** Edit `configs/orientation_offsets.ini`.
2.  **Run:**
    ```bash
    python scripts/calculateOrientationOffsets.py --config configs/orientation_offsets.ini
    ```
3.  **Output:** An Excel file with the results will be saved.

## Monitoring Module

The monitoring module provides functionality for PTZ camera calibration monitoring and query extraction.

### Query Extraction

The `monitoring.query_extractor` module provides an `extract_query()` function to capture camera frames with synchronized telemetry data. It supports two modes:

**Passive Mode** (default): Waits for the camera to be stable (no movement) for a specified duration, then captures a single frame.

**Active Mode**: Commands the camera to specific PTZ positions and captures frames at each position.

#### Usage Example

```python
from monitoring.query_extractor import extract_query

# Passive mode - wait for camera to be stable for 30 seconds
result = extract_query(
    device_id="onvifcam-dev-1",
    stabilize_time=30,
    timeout=300  # 5 minute timeout
)

# Active mode - command camera to specific positions
ptz_stops = [
    (0, 0, 0.0),      # pan, tilt, zoom
    (45, -10, 0.5),
    (90, 10, 0.0)
]
result = extract_query(
    device_id="onvifcam-dev-1",
    active_ptz_stops=ptz_stops
)

# Access results
frames = result['camera_frames']  # List of PIL Images
telemetry = result['telemetry']   # Telemetry data for each frame
positions = result['capture_positions']  # Actual capture positions
temp_dir = result['temp_dir']     # Directory with saved frames
```

#### Function Signature

```python
extract_query(
    device_id: str,
    stabilize_time: int = 30,
    timeout: Optional[int] = None,
    active_ptz_stops: List[Tuple[float, float, float]] = None
) -> Dict
```

**Parameters:**
- `device_id`: Camera device identifier (e.g., "onvifcam-dev-1")
- `stabilize_time`: Seconds of stability required before capture (default: 30)
- `timeout`: Optional timeout in seconds for waiting for stability (None = no timeout)
- `active_ptz_stops`: Optional list of (pan, tilt, zoom) tuples for active mode

**Returns:**
Dictionary containing:
- `camera_frames`: List of captured PIL Images
- `telemetry`: Dictionary mapping frame index to telemetry data
- `capture_positions`: List of (pan, tilt, zoom) positions where frames were captured
- `temp_dir`: Path to temporary directory containing saved frames
- `manifest_path`: Path to telemetry manifest JSON file

## Project Structure

```
ptz-calibration-monitoring/
├── configs/                  # Configuration files for all executables.
├── helpers/                  # Helper modules for camera control and MQTT.
│   ├── camera_control.py    # ONVIF camera control utilities.
│   ├── mqtt_helper.py       # MQTT telemetry monitoring (TelemetryLatch).
│   └── rtsp_helper.py       # RTSP stream capture utilities.
├── monitoring/              # Calibration monitoring modules.
│   └── query_extractor.py   # Query extraction with MQTT stability detection.
├── ptz_georeg/              # The core Python library with all utility functions.
├── scripts/                 # Executable scripts for the main workflow.
├── port_forward_utils.py    # Kubernetes port forwarding utilities.
├── requirements.txt         # List of Python package dependencies.
├── scan.py                  # Grid-based frame capture script.
├── setup.py                 # Makes the `ptz_georeg` folder installable.
└── README.md                # This file.
```